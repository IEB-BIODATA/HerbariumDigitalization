{% extends "base.html" %}
{% load static %}
{% block javascript %}
    <script type="text/javascript">
        const alertLoad = document.getElementById("alert");
        $(document).ready(function() {
            $('#FilesTable').DataTable({
                serverSide: true,
                processing: true,
                language: languageTable.spanish,
                ajax: {
                    url: '{% url "priority_vouchers_table" %}',
                },
                order: [[1, 'desc']],
                columnDefs: [
                    {
                        targets: 0,
                        data: 'herbarium'
                    },
                    {
                        targets: 1,
                        data: 'created_at',
                        render: (data, type) => {
                            let date = new Date(data);
                            if (type === 'display' || type === 'search') {
                                return dateFormat(date)
                            } else if (type === 'sort')
                                return date.toISOString;
                            else
                                return date;
                        }
                    },
                    {
                        targets: 2,
                        data: 'created_by',
                    },
                    {
                        targets: 3,
                        data: 'file_url',
                        render: (data, type, row) => {
                            return `<a href="${data}">${row.filename}</a></td>`
                        }
                    },
                ],
            });
        });

        function print_data_error(data_error) {
            $(document).ajaxSend(function() {
                $("#overlay").fadeIn(300);
            });
            $.ajax({
                data: data_error,
                url: '/digitalization/pdf_error_data',
                type: 'POST',
                success : function(data) {
                    var pdfFile=new Blob([data], {type: "application/pdf"});
                    var pdfUrl = URL.createObjectURL(pdfFile);
                    printJS(pdfUrl);
                }
            }).done(function() {
                setTimeout(function(){
                    $("#overlay").fadeOut(300);
                },500);
            });
        }

        function download_xlsx_data_error(data_error) {
            $(document).ajaxSend(function() {
                $("#overlay").fadeIn(300);
            });
            $.ajax({
                data: data_error,
                url: '/digitalization/xls_error_data',
                type: 'POST',
                xhrFields: {
                    // make sure the response knows we're expecting a binary type in return.
                    // this is important, without it the excel file is marked corrupted.
                    responseType: 'arraybuffer'
                }
            }).done(function (data, status, xmlHeaderRequest) {
                var downloadLink = document.createElement('a');
                var blob = new Blob([data],
                    {
                        type: xmlHeaderRequest.getResponseHeader('Content-Type')
                    });
                var url = window.URL || window.webkitURL;
                var downloadUrl = url.createObjectURL(blob);
                var fileName = 'vouchers_error.xlsx';

                if (typeof window.navigator.msSaveBlob !== 'undefined') {
                    window.navigator.msSaveBlob(blob, fileName);
                } else {
                    if (fileName) {
                        if (typeof downloadLink.download === 'undefined') {
                            window.location = downloadUrl;
                        } else {
                            downloadLink.href = downloadUrl;
                            downloadLink.download = "vouchers_error.xlsx";
                            document.body.appendChild(downloadLink);
                            downloadLink.click();
                        }
                    } else {
                        window.location = downloadUrl;
                    }
                    setTimeout(function () {
                            url.revokeObjectURL(downloadUrl);
                            $("#overlay").fadeOut(300);
                        },
                        100);
                }
            });
        }

        function download_csv_data_error(data_error) {
            $(document).ajaxSend(function() {
                $("#overlay").fadeIn(300);
            });
            $.ajax({
                data: data_error,
                url: '/digitalization/csv_error_data',
                type: 'POST',
                success : function(data) {
                    var uri = 'data:application/csv;charset=UTF-8,' + encodeURIComponent(data);
                    var downloadLink = document.createElement("a");
                    downloadLink.href = uri;
                    downloadLink.download = "vouchers_error.csv";

                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                }
            }).done(function() {
                setTimeout(function(){
                    $("#overlay").fadeOut(300);
                },500);
            });
        }

        function downloadVouchersXLSX() {
            $("#overlay").fadeIn(300);
            $.ajax({
                url: '{% url "vouchers_download" %}',
                type: 'GET',
                xhrFields: {
                    // make sure the response knows we're expecting a binary type in return.
                    // this is important, without it the excel file is marked corrupted.
                    responseType: 'arraybuffer'
                },
            }).done(function (data, status, xmlHeaderRequest) {
                const downloadLink = document.createElement('a');
                const blob = new Blob([data],
                    {
                        type: xmlHeaderRequest.getResponseHeader('Content-Type')
                    });
                const url = window.URL || window.webkitURL;
                const downloadUrl = url.createObjectURL(blob);
                const fileName = 'vouchers.xlsx';

                if (typeof window.navigator.msSaveBlob !== 'undefined') {
                    window.navigator.msSaveBlob(blob, fileName);
                } else {
                    if (fileName) {
                        if (typeof downloadLink.download === 'undefined') {
                            window.location = downloadUrl;
                        } else {
                            downloadLink.href = downloadUrl;
                            downloadLink.download = "vouchers.xlsx";
                            document.body.appendChild(downloadLink);
                            downloadLink.click();
                        }
                    } else {
                        window.location = downloadUrl;
                    }
                    setTimeout(function () {
                        url.revokeObjectURL(downloadUrl);
                        }, 100);
                }
            }).always(function() {
                $("#overlay").fadeOut(300);
            });
        }
    </script>
{% endblock %}
{% block content %}
    <h1>Cargar Excel</h1>

    <form id="fileForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-group">
            {{ form }}
            <div class="row">
                <div class="col-3">
                    <button type="submit" class="btn btn-primary" id="loadButton">Cargar</button>
                </div>
                <div class="offset-md-6 col-3">
                    <a class="btn btn-primary w-100" href="#" onclick="downloadVouchersXLSX()">
                        Descargar Vouchers
                    </a>
                </div>
            </div>
        </div>
    </form>

    {% if task_id %}
    <div id="alert" class="card mb-3">
        <div class="card-body">
            <div id="processProgress" class="progress" role="progressbar" aria-label="progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="display: none;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%">0%</div>
            </div>
            <div role="tab" id="showLog">
                <h6>
                    <a role="button" data-bs-toggle="collapse" data-bs-target="#console-log" aria-expanded="true" aria-controls="consoleLog" class="">
                        Mostrar logs
                    </a>
                </h6>
            </div>
            <div id="consoleLog" class="collapse" role="tabpanel" aria-labelledby="showLog">
                <pre><code id="loggingContent"></code></pre>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="card mb-3">
        <div class="card-header">
            <i class="fas fa-table"></i>
            Tabla de Archivos
        </div>
        <div class="card-body">
            <div class="table-responsive" id="vouchers-content">
                <table class="table table-bordered" id="FilesTable" width="100%" cellspacing="0">
                    <thead>
                    <tr>
                        <th>Herbario</th>
                        <th>Fecha</th>
                        <th>Usuario</th>
                        <th>Archivo</th>
                    </tr>
                    </thead>
                    <tbody>
                        <!-- To be populated -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock %}